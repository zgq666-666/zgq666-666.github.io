<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¤ç‰©å¤§æˆ˜åƒµå°¸ - æœ€ç»ˆå®Œæ•´ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        pvz: {
                            grass: '#78AB46',
                            soil: '#8B4513',
                            sun: '#FFD700',
                            plant: '#2E8B57',
                            zombie: '#4B0082',
                            game: '#1E3A8A',
                            progress: '#ff4757'
                        }
                    }
                }
            }
        }
    </script>
    
    <style type="text/tailwindcss">
        @layer utilities {
            .grid-cols-9 { grid-template-columns: repeat(9, 1fr); }
            .grid-rows-5 { grid-template-rows: repeat(5, 1fr); }
            .animate-sun { animation: sunFloat 8s infinite ease-in-out; }
            .animate-attack { animation: attack 0.5s ease infinite; }
            .hurt { animation: hurt 0.2s ease; }
            .animate-explode { animation: explode 0.5s ease-out; }
        }

        @keyframes sunFloat {
            0%,100% { transform: translate(0,0); }
            50% { transform: translate(5px,-5px); }
        }
        
        @keyframes attack {
            0%,100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        @keyframes hurt {
            0%,100% { filter: brightness(1); }
            50% { filter: brightness(0.5); }
        }
        
        @keyframes explode {
            0% { transform: scale(0); opacity: 1; }
            50% { transform: scale(3); opacity: 0.8; }
            100% { transform: scale(5); opacity: 0; }
        }
        
        /* ç”¨æˆ·åå¼¹çª—æ ·å¼ */
        .username-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }
        
        .username-form {
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            text-align: center;
            min-width: 300px;
        }
        
        .username-form input {
            padding: 10px;
            font-size: 16px;
            width: 80%;
            margin: 10px 0;
            border: 2px solid #ccc;
            border-radius: 5px;
        }
        
        .username-form button {
            padding: 10px 20px;
            background-color: #2E8B57;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 10px;
        }
        
        .username-form button:hover {
            background-color: #1f6e43;
        }
        
        /* æ¸¸æˆæ ¸å¿ƒæ ·å¼ */
        #game-container {
            width: 900px;
            height: 500px;
            margin: 0 auto;
            position: relative;
            border: 2px solid #5a8c3a;
        }
        
        #game-grid {
            width: 100%;
            height: 100%;
            display: grid;
            grid-template-columns: repeat(9, 100px);
            grid-template-rows: repeat(5, 100px);
            gap: 1px;
        }
        
        .game-cell {
            background-color: #78AB46;
            border: 1px solid #5a8c3a;
            position: relative;
            cursor: pointer;
            z-index: 5;
        }
        
        .plant {
            position: absolute;
            z-index: 8;
            width: 80px;
            height: 80px;
            top: 10px;
            left: 10px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            animation: attack 0.5s ease infinite;
        }
        
        /* ä¸åŒåƒµå°¸æ ·å¼ */
        .zombie {
            position: absolute;
            z-index: 10;
            width: 80px;
            height: 80px;
            top: 10px;
            border-radius: 8px;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            transition: left 0.1s linear;
        }
        
        .zombie-normal {
            background-color: #4B0082;
        }
        
        .zombie-trash {
            background-color: #333333;
            border: 3px solid #666666;
        }
        
        .zombie-iron {
            background-color: #222222;
            border: 4px solid #888888;
        }
        
        /* åƒµå°¸å¤´éƒ¨è£…é¥° */
        .zombie-trash::before {
            content: "ğŸ—‘ï¸";
            position: absolute;
            top: -15px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 20px;
        }
        
        .zombie-iron::before {
            content: "ğŸª£";
            position: absolute;
            top: -15px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 20px;
        }
        
        .bullet {
            position: absolute;
            z-index: 9;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background-color: #ff0000;
        }
        
        /* æ¨±æ¡ƒç‚¸å¼¹çˆ†ç‚¸æ•ˆæœ */
        .explosion {
            position: absolute;
            z-index: 50;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: #ff4500;
            box-shadow: 0 0 30px #ff0000;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
            animation: explode 0.5s ease-out forwards;
        }
        
        /* è¿›åº¦æ¡æ ·å¼ */
        .progress-bar {
            width: 900px;
            height: 20px;
            background-color: #333;
            margin: 0 auto 10px;
            position: relative;
            border-radius: 10px;
        }
        
        .progress-fill {
            position: absolute;
            top: 0;
            right: 0;
            width: 100%;
            height: 100%;
            background-color: #ff4757;
            transition: transform 0.1s linear;
            transform: translateX(0);
        }
        
        .progress-end {
            position: absolute;
            top: 0;
            left: 0;
            width: 30px;
            height: 100%;
            background-color: #ff3838;
            z-index: 2;
            border-radius: 10px 0 0 10px;
        }
        
        .progress-text {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            color: white;
            text-align: center;
            line-height: 20px;
            z-index: 3;
            font-size: 14px;
            font-weight: bold;
        }
        
        /* é˜³å…‰æ ·å¼ */
        .sun-item {
            position: absolute;
            z-index: 15;
            cursor: pointer;
            font-size: 28px;
            color: #FFD700;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: auto;
        }
        
        /* å±‚çº§ç®¡ç† */
        #sun-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 12;
            pointer-events: none;
        }
        
        #zombie-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 11;
            pointer-events: none;
        }
        
        #bullet-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
            pointer-events: none;
        }
        
        #explosion-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 40;
            pointer-events: none;
        }
        
        #game-over {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0,0,0,0.8);
            color: white;
            padding: 20px 40px;
            border-radius: 10px;
            font-size: 24px;
            z-index: 20;
            display: none;
        }
        
        /* ç©å®¶ä¿¡æ¯æ˜¾ç¤º */
        .player-info {
            color: #333;
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
            text-align: center;
        }
        
        /* åƒµå°¸ç»Ÿè®¡æ˜¾ç¤º */
        .zombie-stats {
            text-align: center;
            margin: 10px 0;
            color: #666;
            font-size: 14px;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans p-4">
    <div class="max-w-6xl mx-auto">
        <!-- ç”¨æˆ·åå¼¹çª— -->
        <div id="username-modal" class="username-modal">
            <div class="username-form">
                <h2>ğŸŒ± æ¤ç‰©å¤§æˆ˜åƒµå°¸ ğŸŒ±</h2>
                <p>è¯·è¾“å…¥ä½ çš„ç”¨æˆ·å</p>
                <input type="text" id="username-input" placeholder="è¾“å…¥æ˜µç§°..." maxlength="10" required>
                <br>
                <button id="confirm-username">å¼€å§‹æ¸¸æˆ</button>
                <p class="text-red-500 text-sm mt-2" id="username-error" style="display: none;">è¯·è¾“å…¥æœ‰æ•ˆçš„ç”¨æˆ·åï¼</p>
            </div>
        </div>

        <!-- ç©å®¶ä¿¡æ¯ -->
        <div class="player-info" id="player-info" style="display: none;">
            ç©å®¶: <span id="player-name"></span> | å‡»æ€æ•°: <span id="kill-count">0</span>/<span id="kill-total">20</span>
        </div>
        
        <!-- åƒµå°¸ç±»å‹è¯´æ˜ -->
        <div class="zombie-stats" id="zombie-stats" style="display: none;">
            ğŸ§Ÿæ™®é€šåƒµå°¸(15è¡€) | ğŸ—‘ï¸åƒåœ¾æ¡¶åƒµå°¸(22.5è¡€) | ğŸª£é“æ¡¶åƒµå°¸(30è¡€) | ğŸ’æ¨±æ¡ƒç‚¸å¼¹(150é˜³å…‰)ï¼šèŒƒå›´9æ ¼+é‚»è¿‘2è¡Œç§’æ€
        </div>

        <!-- é¡¶éƒ¨æ§åˆ¶åŒº -->
        <div class="flex justify-between items-center mb-4">
            <h1 class="text-2xl font-bold text-green-700">æ¤ç‰©å¤§æˆ˜åƒµå°¸ - æœ€ç»ˆå®Œæ•´ç‰ˆ</h1>
            <div class="flex gap-4 items-center">
                <div class="flex items-center gap-2">
                    <i class="fa fa-sun-o text-yellow-500 text-2xl"></i>
                    <span id="sun-count" class="text-xl font-bold">50</span>
                </div>
                <button id="start-game" class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded transition" disabled>å¼€å§‹æ¸¸æˆ</button>
                <button id="reset-game" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded transition" disabled>é‡ç½®æ¸¸æˆ</button>
            </div>
        </div>

        <!-- æ¤ç‰©é€‰æ‹©åŒº -->
        <div class="flex gap-4 mb-4 flex-wrap">
            <div class="plant-card cursor-pointer p-3 border-2 border-transparent hover:border-yellow-500 rounded bg-green-600 text-white transition" data-plant="peashooter" data-cost="100">
                <i class="fa fa-circle text-xl"></i>
                <div class="mt-1">è±Œè±†å°„æ‰‹ (100é˜³å…‰)</div>
            </div>
            <div class="plant-card cursor-pointer p-3 border-2 border-transparent hover:border-yellow-500 rounded bg-yellow-600 text-white transition" data-plant="sunflower" data-cost="50">
                <i class="fa fa-sun-o text-xl"></i>
                <div class="mt-1">å‘æ—¥è‘µ (50é˜³å…‰)</div>
            </div>
            <div class="plant-card cursor-pointer p-3 border-2 border-transparent hover:border-yellow-500 rounded bg-yellow-800 text-white transition" data-plant="wallnut" data-cost="50">
                <i class="fa fa-square text-xl"></i>
                <div class="mt-1">åšæœå¢™ (50é˜³å…‰)</div>
            </div>
            <div class="plant-card cursor-pointer p-3 border-2 border-transparent hover:border-yellow-500 rounded bg-blue-600 text-white transition" data-plant="snowpea" data-cost="175">
                <i class="fa fa-snowflake-o text-xl"></i>
                <div class="mt-1">å¯’å†°å°„æ‰‹ (175é˜³å…‰)</div>
            </div>
            <div class="plant-card cursor-pointer p-3 border-2 border-transparent hover:border-yellow-500 rounded bg-red-700 text-white transition" data-plant="cherrybomb" data-cost="150">
                <i class="fa fa-bomb text-xl"></i>
                <div class="mt-1">æ¨±æ¡ƒç‚¸å¼¹ (150é˜³å…‰)</div>
            </div>
        </div>

        <!-- è¿›åº¦æ¡ -->
        <div class="progress-bar mb-2">
            <div id="progress-fill" class="progress-fill"></div>
            <div class="progress-end"></div>
            <div class="progress-text">åƒµå°¸è¿›æ”»è¿›åº¦ï¼ˆåˆ°è¾¾å·¦ä¾§çº¢è‰²ç»ˆç‚¹å¤±è´¥ï¼‰</div>
        </div>

        <!-- æ ¸å¿ƒæ¸¸æˆåŒº -->
        <div id="game-container">
            <div id="game-grid" class="grid-cols-9 grid-rows-5"></div>
            <div id="sun-layer"></div>
            <div id="zombie-layer"></div>
            <div id="bullet-layer"></div>
            <div id="explosion-layer"></div>
            <div id="game-over">æ¸¸æˆå¼€å§‹ï¼</div>
        </div>
        
        <!-- æ“ä½œæç¤º -->
        <div class="mt-4 text-center text-gray-600">
            <p>æ“ä½œè¯´æ˜ï¼š1.é€‰æ‹©æ¤ç‰©å¡ç‰‡ â†’ 2.ç‚¹å‡»è‰åªæ”¾ç½®æ¤ç‰© â†’ 3.ç‚¹å‡»é˜³å…‰æ”¶é›†èµ„æº â†’ 4.æ¶ˆç­20ä¸ªåƒµå°¸é€šå…³</p>
            <p class="text-red-600">æ–°å¢å†…å®¹ï¼šæ™®é€š/åƒåœ¾æ¡¶/é“æ¡¶åƒµå°¸ | æ¨±æ¡ƒç‚¸å¼¹èŒƒå›´ç§’æ€ | åƒµå°¸5ç§’ååˆ·æ–° | å‘æ—¥è‘µ1ç§’â†’1.5ç§’äº§é˜³å…‰</p>
        </div>
    </div>

    <script>
        // æ¸¸æˆæ ¸å¿ƒçŠ¶æ€
        const game = {
            isRunning: false,
            username: '',
            sun: 50,
            selectedPlant: null,
            cellSize: 100,
            grid: [],
            plants: [],
            zombies: [],
            suns: [],
            progress: 0,
            // è°ƒæ•´åçš„æ¸¸æˆå‚æ•°
            gameBalance: {
                zombieSpawnDelay: 5000,     // åƒµå°¸å»¶è¿Ÿ5ç§’å¼€å§‹åˆ·æ–°
                zombieSpawnRate: 4500,      // åƒµå°¸åˆ·æ–°é—´éš”ï¼ˆå»¶è¿Ÿåï¼‰
                plantAttackRate: 1200,      // æ¤ç‰©æ”»å‡»é—´éš”
                zombieSpeed: 0.8,           // åƒµå°¸ç§»åŠ¨é€Ÿåº¦
                progressSpeed: 0.04,        // è¿›åº¦æ¡é€Ÿåº¦
                killToWin: 20,              // éœ€è¦æ¶ˆç­20ä¸ªåƒµå°¸é€šå…³
                // åƒµå°¸è¡€é‡é…ç½®
                zombieHealth: {
                    normal: 15,             // æ™®é€šåƒµå°¸åŸºç¡€è¡€é‡
                    trash: 22.5,            // åƒåœ¾æ¡¶åƒµå°¸ï¼ˆ1.5å€ï¼‰
                    iron: 30                // é“æ¡¶åƒµå°¸ï¼ˆ2å€ï¼‰
                },
                plantHealth: {              // æ¤ç‰©è¡€é‡
                    peashooter: 3,
                    sunflower: 3,
                    wallnut: 15,
                    snowpea: 3,
                    cherrybomb: 1           // æ¨±æ¡ƒç‚¸å¼¹ä¸€æ¬¡æ€§ä½¿ç”¨
                },
                bulletDamage: {             // å­å¼¹ä¼¤å®³
                    peashooter: 1,
                    snowpea: 1
                },
                sunSpawnRate: 7000,         // å…¨å±€é˜³å…‰ç”Ÿæˆé€Ÿåº¦
                // å‘æ—¥è‘µäº§é˜³å…‰å‚æ•°
                sunflower: {
                    initialSunRate: 1000,   // å¼€å±€1ç§’äº§ä¸€æ¬¡é˜³å…‰
                    laterSunRate: 1500,     // ä¹‹å1.5ç§’äº§ä¸€æ¬¡é˜³å…‰
                    switchTime: 20000       // 20ç§’ååˆ‡æ¢ä¸ºæ…¢é€Ÿ
                },
                // æ¨±æ¡ƒç‚¸å¼¹é…ç½®
                cherryBomb: {
                    radius: 3,              // 3x3èŒƒå›´ï¼ˆ9æ ¼ï¼‰
                    adjacentRows: 2,        // é‚»è¿‘2è¡Œ
                    damage: 999             // ç§’æ€ä¼¤å®³
                }
            },
            zombieKilled: 0,
            gameStartTime: 0,
            // è®¡æ—¶å™¨
            timers: {
                spawnZombie: null,
                spawnSun: null,
                gameLoop: null,
                zombieStartTimer: null
            }
        };

        // DOMå…ƒç´ 
        const el = {
            // ç”¨æˆ·åç›¸å…³
            usernameModal: document.getElementById('username-modal'),
            usernameInput: document.getElementById('username-input'),
            confirmUsername: document.getElementById('confirm-username'),
            usernameError: document.getElementById('username-error'),
            playerInfo: document.getElementById('player-info'),
            playerName: document.getElementById('player-name'),
            killCount: document.getElementById('kill-count'),
            killTotal: document.getElementById('kill-total'),
            zombieStats: document.getElementById('zombie-stats'),
            
            // æ¸¸æˆæ ¸å¿ƒ
            sunCount: document.getElementById('sun-count'),
            startGame: document.getElementById('start-game'),
            resetGame: document.getElementById('reset-game'),
            plantCards: document.querySelectorAll('.plant-card'),
            gameGrid: document.getElementById('game-grid'),
            sunLayer: document.getElementById('sun-layer'),
            zombieLayer: document.getElementById('zombie-layer'),
            bulletLayer: document.getElementById('bullet-layer'),
            explosionLayer: document.getElementById('explosion-layer'),
            progressFill: document.getElementById('progress-fill'),
            gameOver: document.getElementById('game-over'),
            gameContainer: document.getElementById('game-container')
        };

        // åˆå§‹åŒ–ç”¨æˆ·ååŠŸèƒ½
        function initUsername() {
            // ç¡®è®¤ç”¨æˆ·å
            el.confirmUsername.addEventListener('click', () => {
                const username = el.usernameInput.value.trim();
                
                if (!username || username.length < 2 || username.length > 10) {
                    el.usernameError.style.display = 'block';
                    return;
                }
                
                // ä¿å­˜ç”¨æˆ·å
                game.username = username;
                
                // æ›´æ–°UI
                el.playerName.textContent = username;
                el.killTotal.textContent = game.gameBalance.killToWin;
                el.usernameModal.style.display = 'none';
                el.playerInfo.style.display = 'block';
                el.zombieStats.style.display = 'block';
                
                // å¯ç”¨æ¸¸æˆæŒ‰é’®
                el.startGame.disabled = false;
                el.resetGame.disabled = false;
                
                showMessage(`æ¬¢è¿ ${username}ï¼å‡†å¤‡å¼€å§‹æ¸¸æˆ`, 'green');
            });
            
            // å›è½¦ç¡®è®¤
            el.usernameInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    el.confirmUsername.click();
                }
            });
        }

        // åˆå§‹åŒ–æ¸¸æˆç½‘æ ¼
        function initGrid() {
            el.gameGrid.innerHTML = '';
            game.grid = [];
            
            // åˆ›å»º5è¡Œ9åˆ—çš„æ ¼å­
            for (let row = 0; row < 5; row++) {
                game.grid[row] = [];
                for (let col = 0; col < 9; col++) {
                    game.grid[row][col] = null;
                    
                    const cell = document.createElement('div');
                    cell.className = 'game-cell';
                    cell.dataset.row = row;
                    cell.dataset.col = col;
                    
                    // ç»‘å®šç§æ¤äº‹ä»¶
                    cell.addEventListener('click', () => {
                        if (game.isRunning && game.selectedPlant) {
                            plantAt(row, col);
                        }
                    });
                    
                    el.gameGrid.appendChild(cell);
                }
            }
            
            // æ›´æ–°é˜³å…‰æ˜¾ç¤º
            el.sunCount.textContent = game.sun;
            el.killCount.textContent = game.zombieKilled;
        }

        // åˆå§‹åŒ–æ¤ç‰©é€‰æ‹©
        function initPlantSelection() {
            el.plantCards.forEach(card => {
                card.addEventListener('click', () => {
                    if (!game.isRunning) {
                        showMessage('è¯·å…ˆç‚¹å‡»"å¼€å§‹æ¸¸æˆ"ï¼', 'orange');
                        return;
                    }
                    
                    // æ¸…é™¤æ‰€æœ‰é€‰ä¸­çŠ¶æ€
                    el.plantCards.forEach(c => c.classList.remove('border-yellow-500'));
                    
                    const plantType = card.dataset.plant;
                    const plantCost = parseInt(card.dataset.cost);
                    
                    // æ£€æŸ¥é˜³å…‰æ˜¯å¦è¶³å¤Ÿ
                    if (game.sun >= plantCost) {
                        game.selectedPlant = {
                            type: plantType,
                            cost: plantCost
                        };
                        card.classList.add('border-yellow-500');
                        showMessage(`å·²é€‰æ‹©ï¼š${card.textContent.split('(')[0]}`, 'green');
                    } else {
                        game.selectedPlant = null;
                        showMessage(`é˜³å…‰ä¸è¶³ï¼éœ€è¦${plantCost}é˜³å…‰`, 'red');
                    }
                });
            });
        }

        // ç§æ¤æ¤ç‰©ï¼ˆæ–°å¢æ¨±æ¡ƒç‚¸å¼¹é€»è¾‘ï¼‰
        function plantAt(row, col) {
            // æ£€æŸ¥æ ¼å­æ˜¯å¦ä¸ºç©º
            if (game.grid[row][col] !== null) {
                showMessage('è¿™ä¸ªä½ç½®å·²ç»æœ‰æ¤ç‰©äº†ï¼', 'orange');
                return;
            }
            
            const plantType = game.selectedPlant.type;
            const plantCost = game.selectedPlant.cost;
            
            // æ‰£é™¤é˜³å…‰
            game.sun -= plantCost;
            el.sunCount.textContent = game.sun;
            
            // åˆ›å»ºæ¤ç‰©å…ƒç´ 
            const plant = document.createElement('div');
            plant.className = 'plant';
            
            // è®¾ç½®æ¤ç‰©æ ·å¼
            switch(plantType) {
                case 'peashooter':
                    plant.style.backgroundColor = '#2E8B57';
                    plant.innerHTML = '<i class="fa fa-circle"></i>';
                    break;
                case 'sunflower':
                    plant.style.backgroundColor = '#FFD700';
                    plant.innerHTML = '<i class="fa fa-sun-o"></i>';
                    break;
                case 'wallnut':
                    plant.style.backgroundColor = '#8B4513';
                    plant.innerHTML = '<i class="fa fa-square"></i>';
                    break;
                case 'snowpea':
                    plant.style.backgroundColor = '#1E90FF';
                    plant.innerHTML = '<i class="fa fa-snowflake-o"></i>';
                    break;
                case 'cherrybomb':
                    plant.style.backgroundColor = '#FF0000';
                    plant.style.animation = 'none'; // å–æ¶ˆæ”»å‡»åŠ¨ç”»
                    plant.innerHTML = '<i class="fa fa-bomb"></i>';
                    break;
            }
            
            // è®¡ç®—æ¤ç‰©ä½ç½®
            plant.style.left = `${10}px`;
            plant.style.top = `${10}px`;
            
            // æ·»åŠ åˆ°æ ¼å­ä¸­
            const cell = el.gameGrid.children[row * 9 + col];
            cell.appendChild(plant);
            
            // ä¿å­˜æ¤ç‰©æ•°æ®
            const plantData = {
                id: Date.now(),
                type: plantType,
                row: row,
                col: col,
                health: game.gameBalance.plantHealth[plantType],
                element: plant,
                lastAttack: 0,
                lastSun: 0,
                x: col * game.cellSize + game.cellSize/2,
                y: row * game.cellSize + game.cellSize/2,
                // æ¨±æ¡ƒç‚¸å¼¹ç‰¹æœ‰å±æ€§
                exploded: false
            };
            
            // æ›´æ–°ç½‘æ ¼çŠ¶æ€
            game.grid[row][col] = plantData;
            game.plants.push(plantData);
            
            // æ¨±æ¡ƒç‚¸å¼¹ç«‹å³è§¦å‘çˆ†ç‚¸
            if (plantType === 'cherrybomb') {
                setTimeout(() => {
                    triggerCherryBomb(plantData);
                }, 500); // å»¶è¿Ÿ500msè§¦å‘ï¼Œå¢åŠ è§†è§‰æ•ˆæœ
            }
            
            // å–æ¶ˆæ¤ç‰©é€‰æ‹©
            el.plantCards.forEach(c => c.classList.remove('border-yellow-500'));
            game.selectedPlant = null;
            
            // æ˜¾ç¤ºæç¤º
            const plantName = plantType === 'peashooter' ? 'è±Œè±†å°„æ‰‹' : 
                             plantType === 'sunflower' ? 'å‘æ—¥è‘µ' : 
                             plantType === 'wallnut' ? 'åšæœå¢™' : 
                             plantType === 'snowpea' ? 'å¯’å†°å°„æ‰‹' : 'æ¨±æ¡ƒç‚¸å¼¹';
            showMessage(`å·²æ”¾ç½®${plantName}`, 'green');
        }

        // è§¦å‘æ¨±æ¡ƒç‚¸å¼¹çˆ†ç‚¸ï¼ˆæ ¸å¿ƒåŠŸèƒ½ï¼‰
        function triggerCherryBomb(cherryData) {
            if (cherryData.exploded) return;
            
            cherryData.exploded = true;
            const row = cherryData.row;
            const col = cherryData.col;
            
            // åˆ›å»ºçˆ†ç‚¸æ•ˆæœ
            const explosion = document.createElement('div');
            explosion.className = 'explosion';
            explosion.style.left = `${cherryData.x - 30}px`;
            explosion.style.top = `${cherryData.y - 30}px`;
            explosion.innerHTML = '<i class="fa fa-bomb"></i>';
            el.explosionLayer.appendChild(explosion);
            
            // æ’­æ”¾çˆ†ç‚¸éŸ³æ•ˆï¼ˆè§†è§‰æ¨¡æ‹Ÿï¼‰
            showMessage('ğŸ’¥ æ¨±æ¡ƒç‚¸å¼¹çˆ†ç‚¸ï¼èŒƒå›´ç§’æ€ï¼', 'red', 1000);
            
            // 1. 3x3èŒƒå›´ï¼ˆ9æ ¼ï¼‰å†…çš„åƒµå°¸
            const startRow = Math.max(0, row - 1);
            const endRow = Math.min(4, row + 1);
            const startCol = Math.max(0, col - 1);
            const endCol = Math.min(8, col + 1);
            
            // 2. é‚»è¿‘2è¡Œæ‰©å±•
            const extendedStartRow = Math.max(0, row - 2);
            const extendedEndRow = Math.min(4, row + 2);
            
            // æ”¶é›†æ‰€æœ‰éœ€è¦ç§’æ€çš„åƒµå°¸
            const zombiesToKill = [];
            
            game.zombies.forEach(zombie => {
                // æ£€æŸ¥æ˜¯å¦åœ¨3x3èŒƒå›´ æˆ– é‚»è¿‘2è¡Œå†…
                const in3x3Range = zombie.row >= startRow && zombie.row <= endRow && 
                                  Math.floor(zombie.x / 100) >= startCol && Math.floor(zombie.x / 100) <= endCol;
                
                const inAdjacentRows = zombie.row >= extendedStartRow && zombie.row <= extendedEndRow;
                
                if (in3x3Range || inAdjacentRows) {
                    zombiesToKill.push(zombie);
                }
            });
            
            // ç§’æ€æ‰€æœ‰èŒƒå›´å†…çš„åƒµå°¸
            zombiesToKill.forEach(zombie => {
                zombie.element.remove();
                game.zombies = game.zombies.filter(z => z.id !== zombie.id);
                game.zombieKilled++;
                el.killCount.textContent = game.zombieKilled;
                
                // æ£€æŸ¥é€šå…³
                if (game.zombieKilled >= game.gameBalance.killToWin) {
                    endGame(true);
                }
            });
            
            // ç§»é™¤æ¨±æ¡ƒç‚¸å¼¹æ¤ç‰©
            cherryData.element.remove();
            game.grid[cherryData.row][cherryData.col] = null;
            game.plants = game.plants.filter(p => p.id !== cherryData.id);
            
            // ç§»é™¤çˆ†ç‚¸æ•ˆæœ
            setTimeout(() => {
                explosion.remove();
            }, 500);
        }

        // ç”Ÿæˆé˜³å…‰
        function spawnSun() {
            if (!game.isRunning) return;
            
            const x = Math.random() * (800) + 50;
            const y = Math.random() * (400) + 50;
            
            const sun = document.createElement('div');
            sun.className = 'sun-item animate-sun';
            sun.style.left = `${x}px`;
            sun.style.top = `${y}px`;
            sun.innerHTML = '<i class="fa fa-sun-o"></i>';
            sun.dataset.id = Date.now();
            
            // é˜³å…‰ç‚¹å‡»äº‹ä»¶
            sun.addEventListener('click', (e) => {
                e.stopPropagation();
                game.sun += 25;
                el.sunCount.textContent = game.sun;
                sun.remove();
                game.suns = game.suns.filter(s => s.id === parseInt(sun.dataset.id));
                showMessage('æ”¶é›†é˜³å…‰+25', 'yellow');
            });
            
            const sunData = {
                id: parseInt(sun.dataset.id),
                element: sun
            };
            
            game.suns.push(sunData);
            el.sunLayer.appendChild(sun);
            
            // 12ç§’åæ¶ˆå¤±
            setTimeout(() => {
                if (document.body.contains(sun)) {
                    sun.remove();
                }
            }, 12000);
        }

        // å‘æ—¥è‘µç”Ÿäº§é˜³å…‰
        function sunflowerProduceSun() {
            if (!game.isRunning || !game.gameStartTime) return;
            
            const now = Date.now();
            // è®¡ç®—æ¸¸æˆå·²è¿è¡Œæ—¶é—´
            const gameDuration = now - game.gameStartTime;
            
            // ç¡®å®šå½“å‰å‘æ—¥è‘µäº§é˜³å…‰é€Ÿåº¦
            const currentSunRate = gameDuration < game.gameBalance.sunflower.switchTime 
                ? game.gameBalance.sunflower.initialSunRate 
                : game.gameBalance.sunflower.laterSunRate;
            
            game.plants.forEach(plant => {
                if (plant.type === 'sunflower') {
                    // ä½¿ç”¨åŠ¨æ€è°ƒæ•´çš„äº§é˜³å…‰é—´éš”
                    if (!plant.lastSun || now - plant.lastSun > currentSunRate) {
                        const sun = document.createElement('div');
                        sun.className = 'sun-item animate-sun';
                        sun.style.left = `${plant.x - 20}px`;
                        sun.style.top = `${plant.y - 20}px`;
                        sun.innerHTML = '<i class="fa fa-sun-o"></i>';
                        
                        sun.addEventListener('click', (e) => {
                            e.stopPropagation();
                            game.sun += 25;
                            el.sunCount.textContent = game.sun;
                            sun.remove();
                        });
                        
                        el.sunLayer.appendChild(sun);
                        plant.lastSun = now;
                        
                        // é˜³å…‰å­˜æ´»æ—¶é—´ç¼©çŸ­
                        setTimeout(() => {
                            if (document.body.contains(sun)) sun.remove();
                        }, 5000);
                    }

                }
            });
        }

        // éšæœºç”Ÿæˆä¸åŒç±»å‹çš„åƒµå°¸
        function spawnRandomZombie() {
            if (!game.isRunning) return;
            
            const row = Math.floor(Math.random() * 5);
            // éšæœºé€‰æ‹©åƒµå°¸ç±»å‹ï¼ˆæ¦‚ç‡ï¼šæ™®é€š60%ï¼Œåƒåœ¾æ¡¶25%ï¼Œé“æ¡¶15%ï¼‰
            const zombieType = Math.random() < 0.6 ? 'normal' : (Math.random() < 0.6 ? 'trash' : 'iron');
            
            // åˆ›å»ºåƒµå°¸å…ƒç´ 
            const zombie = document.createElement('div');
            zombie.className = `zombie zombie-${zombieType}`;
            zombie.innerHTML = '<i class="fa fa-user"></i>';
            zombie.style.left = `${900}px`;
            zombie.style.top = `${row * 100 + 10}px`;
            
            // è·å–å¯¹åº”è¡€é‡
            const zombieHealth = game.gameBalance.zombieHealth[zombieType];
            
            // åƒµå°¸æ•°æ®
            const zombieData = {
                id: Date.now(),
                type: zombieType,
                row: row,
                health: zombieHealth,
                speed: game.gameBalance.zombieSpeed * (zombieType === 'iron' ? 0.9 : 1), // é“æ¡¶åƒµå°¸ç•¥æ…¢
                element: zombie,
                x: 900,
                y: row * 100 + 50,
                slowed: false,
                lastAttack: 0
            };
            
            game.zombies.push(zombieData);
            el.zombieLayer.appendChild(zombie);
            
            // æ˜¾ç¤ºåƒµå°¸ç±»å‹æç¤º
            const zombieTypeName = zombieType === 'normal' ? 'æ™®é€š' : (zombieType === 'trash' ? 'åƒåœ¾æ¡¶' : 'é“æ¡¶');
            if (Math.random() < 0.3) { // 30%æ¦‚ç‡æ˜¾ç¤ºæç¤º
                showMessage(`å‡ºç°${zombieTypeName}åƒµå°¸ï¼`, 'orange', 1000);
            }
        }

        // å¯åŠ¨åƒµå°¸åˆ·æ–°ï¼ˆå»¶è¿Ÿ5ç§’ï¼‰
        function startZombieSpawn() {
            // å…ˆæ˜¾ç¤ºæç¤º
            showMessage('5ç§’ååƒµå°¸å³å°†æ¥è¢­ï¼è¯·å°½å¿«ç§æ¤æ¤ç‰©é˜²å¾¡', 'orange', 4000);
            
            // å»¶è¿Ÿ5ç§’å¼€å§‹åˆ·æ–°åƒµå°¸
            game.timers.zombieStartTimer = setTimeout(() => {
                if (!game.isRunning) return;
                
                // ç¬¬ä¸€ä¸ªåƒµå°¸å›ºå®šä¸ºæ™®é€šåƒµå°¸
                spawnSpecificZombie('normal');
                showMessage('åƒµå°¸å¼€å§‹è¿›æ”»ï¼é¦–å…ˆå‡ºç°æ™®é€šåƒµå°¸', 'red');
                
                // å¯åŠ¨åƒµå°¸åˆ·æ–°è®¡æ—¶å™¨ï¼ˆéšæœºç”Ÿæˆä¸åŒç±»å‹ï¼‰
                game.timers.spawnZombie = setInterval(spawnRandomZombie, game.gameBalance.zombieSpawnRate);
            }, game.gameBalance.zombieSpawnDelay);
        }

        // ç”ŸæˆæŒ‡å®šç±»å‹çš„åƒµå°¸
        function spawnSpecificZombie(zombieType) {
            const row = Math.floor(Math.random() * 5);
            const zombie = document.createElement('div');
            zombie.className = `zombie zombie-${zombieType}`;
            zombie.innerHTML = '<i class="fa fa-user"></i>';
            zombie.style.left = `${900}px`;
            zombie.style.top = `${row * 100 + 10}px`;
            
            const zombieHealth = game.gameBalance.zombieHealth[zombieType];
            
            const zombieData = {
                id: Date.now(),
                type: zombieType,
                row: row,
                health: zombieHealth,
                speed: game.gameBalance.zombieSpeed * (zombieType === 'iron' ? 0.9 : 1),
                element: zombie,
                x: 900,
                y: row * 100 + 50,
                slowed: false,
                lastAttack: 0
            };
            
            game.zombies.push(zombieData);
            el.zombieLayer.appendChild(zombie);
        }

        // æ¤ç‰©æ”»å‡»é€»è¾‘
        function plantAttack() {
            const now = Date.now();
            
            game.plants.forEach(plant => {
                if (plant.type !== 'peashooter' && plant.type !== 'snowpea') return;
                
                // ä½¿ç”¨å¹³è¡¡åçš„æ”»å‡»é—´éš”
                if (now - plant.lastAttack < game.gameBalance.plantAttackRate) return;
                
                // æ‰¾åŒä¸€è¡Œçš„åƒµå°¸
                const rowZombies = game.zombies.filter(z => z.row === plant.row);
                if (rowZombies.length === 0) return;
                
                // æœ€è¿‘çš„åƒµå°¸
                const nearestZombie = rowZombies.reduce((prev, curr) => 
                    curr.x < prev.x ? curr : prev
                );
                
                if (nearestZombie.x > plant.x) {
                    fireBullet(plant, nearestZombie);
                    plant.lastAttack = now;
                }
            });
        }

        // å‘å°„å­å¼¹
        function fireBullet(plant, zombie) {
            const bullet = document.createElement('div');
            bullet.className = 'bullet';
            bullet.style.left = `${plant.x + 20}px`;
            bullet.style.top = `${plant.y - 10}px`;
            bullet.style.backgroundColor = plant.type === 'snowpea' ? '#1E90FF' : '#FF0000';
            
            el.bulletLayer.appendChild(bullet);
            
            // å­å¼¹é€Ÿåº¦ç•¥å¾®é™ä½
            const bulletInterval = setInterval(() => {
                const currentX = parseFloat(bullet.style.left);
                bullet.style.left = `${currentX + 10}px`; // å­å¼¹é€Ÿåº¦å‡æ…¢
                
                // ç¢°æ’æ£€æµ‹
                if (currentX >= zombie.x - 50 && currentX <= zombie.x + 50) {
                    // ä½¿ç”¨å¹³è¡¡åçš„ä¼¤å®³
                    zombie.health -= game.gameBalance.bulletDamage[plant.type];
                    zombie.element.classList.add('hurt');
                    setTimeout(() => zombie.element.classList.remove('hurt'), 200);
                    
                    // å¯’å†°å‡é€Ÿæ•ˆæœå‡å¼±
                    if (plant.type === 'snowpea' && !zombie.slowed) {
                        zombie.speed *= 0.7;
                        zombie.slowed = true;
                    }
                    
                    clearInterval(bulletInterval);
                    bullet.remove();
                    
                    // åƒµå°¸æ­»äº¡
                    if (zombie.health <= 0) {
                        zombie.element.remove();
                        game.zombies = game.zombies.filter(z => z.id !== zombie.id);
                        game.zombieKilled++;
                        
                        // æ›´æ–°å‡»æ€æ•°æ˜¾ç¤º
                        el.killCount.textContent = game.zombieKilled;
                        
                        const zombieTypeName = zombie.type === 'normal' ? 'æ™®é€š' : (zombie.type === 'trash' ? 'åƒåœ¾æ¡¶' : 'é“æ¡¶');
                        showMessage(`å‡»æ€${zombieTypeName}åƒµå°¸ï¼å‰©ä½™ï¼š${game.gameBalance.killToWin - game.zombieKilled}`, 'green');
                        
                        // æ£€æŸ¥é€šå…³
                        if (game.zombieKilled >= game.gameBalance.killToWin) {
                            endGame(true);
                        }
                    }
                }
                
                // è¶…å‡ºèŒƒå›´
                if (currentX > 900) {
                    clearInterval(bulletInterval);
                    bullet.remove();
                }
            }, 15);
        }

        // æ›´æ–°åƒµå°¸ä½ç½®å’Œç¢°æ’æ£€æµ‹
        function updateZombies() {
            game.zombies.forEach(zombie => {
                let hitPlant = false;
                
                // æ£€æŸ¥æ˜¯å¦ç¢°åˆ°æ¤ç‰©
                game.plants.forEach(plant => {
                    if (plant.row === zombie.row && zombie.x <= plant.x + 60 && zombie.x > plant.x - 20) {
                        hitPlant = true;
                        
                        // æ”»å‡»æ¤ç‰©
                        if (Date.now() - zombie.lastAttack > 1000) {
                            plant.health--;
                            plant.element.classList.add('hurt');
                            setTimeout(() => plant.element.classList.remove('hurt'), 200);
                            
                            // æ¤ç‰©æ­»äº¡
                            if (plant.health <= 0) {
                                plant.element.remove();
                                game.grid[plant.row][plant.col] = null;
                                game.plants = game.plants.filter(p => p.id !== plant.id);
                                hitPlant = false;
                                showMessage('æ¤ç‰©è¢«æ‘§æ¯ï¼', 'red');
                            }
                            
                            zombie.lastAttack = Date.now();
                        }
                    }
                });
                
                // ç§»åŠ¨åƒµå°¸
                if (!hitPlant) {
                    zombie.x -= zombie.speed;
                    zombie.element.style.left = `${zombie.x}px`;
                    
                    // åˆ°è¾¾ç»ˆç‚¹
                    if (zombie.x < 30) {
                        endGame(false);
                    }
                }
            });
        }

        // æ›´æ–°è¿›åº¦æ¡
        function updateProgress() {
            game.progress += game.gameBalance.progressSpeed;
            el.progressFill.style.transform = `translateX(-${game.progress}%)`;
            
            if (game.progress >= 100) {
                endGame(false);
            }
        }

        // æ¸¸æˆä¸»å¾ªç¯
        function gameLoop() {
            if (!game.isRunning) return;
            
            sunflowerProduceSun();
            plantAttack();
            updateZombies();
            updateProgress();
            
            game.timers.gameLoop = setTimeout(gameLoop, 30);
        }

        // å¼€å§‹æ¸¸æˆ
        el.startGame.addEventListener('click', () => {
            if (game.isRunning) {
                showMessage('æ¸¸æˆå·²ç»å¼€å§‹ï¼', 'orange');
                return;
            }
            
            game.isRunning = true;
            game.gameStartTime = Date.now();
            game.zombieKilled = 0;
            game.progress = 0;
            el.progressFill.style.transform = 'translateX(0)';
            el.killCount.textContent = game.zombieKilled;
            
            // ç«‹å³ç”Ÿæˆé˜³å…‰
            spawnSun();
            
            // å¯åŠ¨å…¨å±€é˜³å…‰ç”Ÿæˆ
            game.timers.spawnSun = setInterval(spawnSun, game.gameBalance.sunSpawnRate);
            
            // å¯åŠ¨åƒµå°¸å»¶è¿Ÿåˆ·æ–°
            startZombieSpawn();
            
            // å¯åŠ¨æ¸¸æˆå¾ªç¯
            gameLoop();
            
            showMessage(`æ¸¸æˆå¼€å§‹ï¼5ç§’ååƒµå°¸æ¥è¢­ï¼Œéœ€è¦æ¶ˆç­${game.gameBalance.killToWin}ä¸ªåƒµå°¸é€šå…³ï¼`, 'green', 4000);
        });

        // é‡ç½®æ¸¸æˆ
        el.resetGame.addEventListener('click', () => {
            // åœæ­¢æ‰€æœ‰è®¡æ—¶å™¨
            Object.values(game.timers).forEach(timer => {
                if (timer) clearInterval(timer);
                if (timer) clearTimeout(timer);
            });
            
            // æ¸…ç©ºæ‰€æœ‰å…ƒç´ 
            el.sunLayer.innerHTML = '';
            el.zombieLayer.innerHTML = '';
            el.bulletLayer.innerHTML = '';
            el.explosionLayer.innerHTML = '';
            
            // é‡ç½®æ¸¸æˆçŠ¶æ€
            game.isRunning = false;
            game.gameStartTime = 0;
            game.sun = 50;
            game.selectedPlant = null;
            game.plants = [];
            game.zombies = [];
            game.suns = [];
            game.progress = 0;
            game.zombieKilled = 0;
            
            // æ›´æ–°UI
            el.sunCount.textContent = game.sun;
            el.progressFill.style.transform = 'translateX(0)';
            el.killCount.textContent = game.zombieKilled;
            el.plantCards.forEach(card => card.classList.remove('border-yellow-500'));
            
            // é‡æ–°åˆå§‹åŒ–ç½‘æ ¼
            initGrid();
            
            showMessage('æ¸¸æˆå·²é‡ç½®ï¼', 'blue');
        });

        // ç»“æŸæ¸¸æˆ
        function endGame(victory) {
            game.isRunning = false;
            
            // åœæ­¢æ‰€æœ‰è®¡æ—¶å™¨
            Object.values(game.timers).forEach(timer => {
                if (timer) clearInterval(timer);
                if (timer) clearTimeout(timer);
            });
            
            if (victory) {
                showMessage(`æ­å–œ ${game.username}ï¼æˆåŠŸæ¶ˆç­${game.gameBalance.killToWin}ä¸ªåƒµå°¸ï¼Œé€šå…³æˆåŠŸï¼ğŸ‰`, 'green', 6000);
            } else {
                showMessage(`å¾ˆé—æ†¾ ${game.username}ï¼åƒµå°¸åˆ°è¾¾ç»ˆç‚¹ï¼Œæ¸¸æˆå¤±è´¥ï¼ğŸ’€`, 'red', 6000);
            }
        }

        // æ˜¾ç¤ºæç¤ºä¿¡æ¯
        function showMessage(text, color = 'white', duration = 2000) {
            el.gameOver.textContent = text;
            el.gameOver.style.color = color;
            el.gameOver.style.display = 'block';
            
            setTimeout(() => {
                el.gameOver.style.display = 'none';
            }, duration);
        }

        // åˆå§‹åŒ–æ¸¸æˆ
        function initGame() {
            initUsername();
            initGrid();
            initPlantSelection();
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', initGame);
    </script>
</body>
</html>
